<!doctype html><html lang=zh dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>我们仍未确定那天所见变量的状态 | Zonowry 的博客</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<link rel=stylesheet href=/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=/js/fontawesome.min.8c77c7521b1f95ec2031c2a79f5c6a698aa4a0dba5ba649dfbc7f73994cddf3f494be6aac7e5724f35cbf72cfde09703.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=/images/avatar_hu592978886036387a2c13d6a63e534067_442061_32x32_fill_box_center_3.png><link rel=apple-touch-icon sizes=180x180 href=/images/avatar_hu592978886036387a2c13d6a63e534067_442061_180x180_fill_box_center_3.png><meta name=description content="从前有个程序员遇到了一个性能问题。他想，没事，我懂，用线程就好了。现他有在个两题了问。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章列表","item":"/posts/"},{"@type":"ListItem","position":2,"name":"我们仍未确定那天所见变量的状态","item":"/posts/unknown-the-status-of-the-variables-we-saw-that-day/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/unknown-the-status-of-the-variables-we-saw-that-day/"},"headline":"我们仍未确定那天所见变量的状态 | Zonowry 的博客","datePublished":"2024-01-26T00:00:00+00:00","dateModified":"2024-01-26T00:00:00+00:00","wordCount":2930,"publisher":{"@type":"Person","name":"WANG Chucheng","logo":{"@type":"ImageObject","url":"/images/avatar.png"}},"description":"从前有个程序员遇到了一个性能问题。他想，没事，我懂，用线程就好了。现他有在个两题了问。"}</script><meta property="og:title" content="我们仍未确定那天所见变量的状态 | Zonowry 的博客"><meta property="og:type" content="article"><meta property="og:image" content="/images/avatar.png"><meta property="og:url" content="/posts/unknown-the-status-of-the-variables-we-saw-that-day/"><meta property="og:description" content="从前有个程序员遇到了一个性能问题。他想，没事，我懂，用线程就好了。现他有在个两题了问。"><meta property="og:locale" content="zh"><meta property="og:site_name" content="Zonowry 的博客"><meta property="article:published_time" content="2024-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2024-01-26T00:00:00+00:00"><meta property="article:section" content="posts"><meta property="og:see_also" content="/posts/how-to-write-code-that-is-easy-to-maintain/"><meta property="og:see_also" content="/posts/build-a-proxy-gateway-based-on-iptables-and-clash/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Zonowry 的博客</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">首页</a>
<a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">文章</a>
<a href=/thinks/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">碎碎念</a>
<a href=/firends/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">友链</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>浅色</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>深色</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>自动</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>我们仍未确定那天所见变量的状态</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2024-01-26</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>6分钟阅读时长</span></div></div><h2 id=引言>引言</h2><p>总是在说多线程，如果只是关注如何使用多线程，只会在代码里挖坑，就像这个段子一样
「从前有个程序员遇到了一个性能问题。他想，没事，我懂，用线程就好了。现他有在个两题了问」</p><p>为了避免这种情况，我们应该思考的是为什么需要多线程，为什么 <code>js</code> 里没有多线程等诸类问题？也就是——让我们往「下面 <code>the lower</code> 」走一点。</p><h2 id=理论指导实践>理论指导实践</h2><p>首先放弃多线程这个术语，切换到「任务/执行单元」思考模式。分析 <code>thread（线程）</code>、<code>coroutine（协程）</code>、<code>reactive（反应式）</code>、<code>event/task queue（任务队列）</code> ，这些都是实现并发编程的一些手段，抛开掉上层的一些实现，本质上它们只是对<strong>执行单元定义与调度</strong>的抽象实现。所以来思考「执行单元」的定义、调度会是什么，再来理解这些手段简直易如反掌。</p><h3 id=任务执行单元定义>任务/执行单元定义</h3><p>任务/执行单元就是一个可以执行的内容。可以是线程、协程、观察者订阅、未来任务/事件处理回调&mldr;不在任务/执行单元定义上浪费精力，当作一个抽象概念，方便我们讨论即可。下文就简称为<strong>任务</strong>了。</p><h3 id=抢占式调度>抢占式调度</h3><p>首先是最常见的抢占式调度，操作系统的调度方式。</p><p>任务间呈现为竞争关系，A 任务与 B 任务互相抢占执行。最常见的例子就是：“操作系统利用 cpu 时钟中断时，实行的多线程的工作模式，每次中断都代表某个线程抢到了 CPU 时间片”。</p><p>在操作系统的抢占式的机制下，一个程序想要并发执行多任务，首先需要分割代码，这样不同的代码块得以快速交替执行，看起来像同时运行一样，就是并发了。那如何让代码块适配兼容操作系统的抢占式调度，<strong>线程</strong>就被设计出来了。我们编写代码时，如果想要某个代码块并发执行，一般只需要 <code>new Thread</code>，接着 <strong>run it</strong> 。之后的事情就是操作系统来调度了，也就是没法确定这个代码块（线程）什么时候会被执行（一般很快）。</p><h3 id=协作式调度>协作式调度</h3><p>也叫非抢占式，主动让渡控制权，A 任务与 B 任务可以在合适的时机主动让渡控制权。特点就是主动让出，也即不需要依靠操作系统中断，我们就可以让出控制权，A 任务主动暂停（中断）执行，把控制权让给 B 任务。这个特性我们可以在用户代码层面就可以很简单的实现，也就出现了反应式、非阻塞等相关概念的框架，例如 <code>rxjava</code>、<code>webflux</code>、<code>r2dbc</code> 等等，有的语言在编译器层面就支持了了一些并发语法糖，例如 <code>async</code>、<code>suspand</code> 之类的。</p><h3 id=线程与协程>线程与协程</h3><p>线程、协程和并发确实密不可分，但线程、协程都是一种<strong>执行单元</strong>，我认为不是并发的核心思想，避开下误区，思考以下问题。</p><p><strong>线程是抢占式吗？</strong></p><p>由于「线程」加上「操作系统中断」就是一个天然的「抢占式框架」了，我们通常会把抢占式和线程绑定，这样理解没问题。</p><p>但也可以这样理解。我们可以基于线程搞个协作式调度，例如 A 线程只处理任务的第一个阶段，完成后发个事件。接着<strong>等待一个合适的时机</strong>，启动新线程处理该事件，继续执行任务的后续阶段。这样就像 A 线程主动让出了控制权一样，这种角度看线程就是协作式调度了。 有没有感觉有点像 <code>rxjava</code> 的 <code>publishOn</code>、<code>subscribeOn</code>。</p><p><strong>那协程一定是协作式的吗？</strong></p><p>大家一般把协程叫做「用户态线程」。理论上抢占式也可以在用户代码层实现，例如 <code>golang</code> 的协程就支持抢占式。</p><p>协作式的特性可以让我们像编写同步代码一样，基本不需要考虑这么一看好像抢占式没有优势，协作式全是优点。但抢占式确有个必不可少特性，因为它能确保任务总能执行。总会有一个老大哥样的角色，例如”操作系统“，平等的对待每一个线程，确保每个线程都能跑几毫秒。如果是协作式，当一个任务耗时很长，迟迟不让渡，其它的任务就干巴巴等它完成了。</p><p>所以我认为要理解并发，核心主要还是在它们的工作模式上：「主动开始（抢占），被动停止（中断）」和「主动停止（让渡），被动开始（接手）」。</p><h2 id=实践中的问题>实践中的问题</h2><p>了解了并发的基本理论，再分析实践中的线程安全这种日经问题，原因只有「并发环境下访问共享可变的状态」。但为什么<strong>共享状态</strong>这个操作会引起问题？因为数据读写不一致。为什么会读写不一致？那就需要看一看多任务是如何读写状态的。</p><h3 id=内存模型一致性>内存模型，一致性</h3><p>数据一致性问题，或者说可见性，就牵扯到内存模型。<code>java</code> 等高级语言搞得内存模型都是基于物理硬件的抽象，例如 <code>JMM (Java Memory Model)</code>，所以归根结底得看 <strong>cpu 高速缓存</strong>和<strong>主内存</strong>（内存条）的关系。</p><p>要知道 cpu 的计算速度可比内存条的读写速度高几个数量级，计算完一个数据就立马写入内存，会严重拖累 cpu 的计算速度。于是 cpu 中也有寄存器、高速缓存等存储区域，cpu 主要读写存储区域，速度比和主内存通信快多了，但数量上肯定比不过主内存。所以 cpu 执行一个代码块（单元）时，一般先从主内存读取数据拷贝到高速缓存里，之后就是 cpu 读写高速缓存了，然后适时的将高速缓存里的数据刷写到主内存中。由此看出从硬件层面上，为了提高性能，就无法避免的有类似缓冲、数据同步的概念。有数据同步就不可避免地有数据一致性问题了。</p><p><code>java</code> 等高级语言为了避免我们太操心这些事情，设计实现了很多概念。运行时内存区域（堆栈、方法区&mldr;）， 这些语言的编译器也都有高度封装的内存模型，负责线程间通信同步，保证线程数据同步、隔离等等。在用这些高级语言编程时，cpu 高速缓存与主内存如何通信对我们来说是透明的，基本不需要去了解，大大简化了编码的复杂程度。</p><h3 id=算法操作原子性>算法操作，原子性</h3><p>内存区域、内存模型只是为了更容易的并发编程踏出的第一步。现在让我们暂时抛开引用类型、值类型、堆栈、内存模型、<strong>指令重排</strong>等知识，假设代码中不论何时获取变量，都是直接去物理内存中拿实时数据，<strong>不考虑性能</strong>，类似于数据库的<strong>读未提交</strong>事务级别、<code>java</code> 的 <code>volatile</code> 关键字。这种情况下，所有的线程的数据读写是实时同步的，可以保证所有线程共享数据的一致性。这样能解决线程安全问题吗？不行，因为代码不只有数据，还有算法（指令与逻辑）。</p><p>这就和一个耳熟能详的特性——「<strong>原子性</strong>」有关了，看一个简单例子就能知道数据一致性不能完全解决线程安全问题的原因。</p><pre><code class=language-kotlin>lateinit var flag: Boolean

// run in A Thread
fun aThread {
    flag = true
    printLn(&quot;just do someting and then&quot;)
    if(flag) {
	    printLn(&quot;when can i do ?&quot;)
	}
}

// run in B Thread
fun bThread {
	flag = false
}
</code></pre><p>假设 <code>aThread</code> 与 <code>bTread</code> 并发执行。先执行到了 <code>aThread</code> 的 <code>just do something and then</code>，这时触发中断，<code>bThread</code> 抢到控制权开始执行，将 <code>flag</code> 设为 <code>false</code>。导致 <code>aThread</code> 本该执行的 <code>when can i do</code> 跑不了。</p><p>可以看出 <code>flag</code> 数据是一致性了，但算法交替运行还是会发生问题。怎么解决例子中的问题？我们需要让 <code>aThread</code> 的执行不可被打断。即要么一次执行完 <code>aThread</code> 这个方法，要么就不要执行。这个特性就是<strong>原子性</strong>了，叫这个名字是因为不可打断的操作和原子不可分割的特性很像。</p><h3 id=合适的同步>合适的“同步”</h3><p>说好的并发呢，怎么扯起同步来了 👿️”。没办法，要想实现原子性，只能靠一些手段，这些手段会造成同步的效果，<code>java</code> 作者在他的书中写过：</p><blockquote><p>如果当多个线程访问同一个可变的状态变量时没有使用合适的同步，那么程序就会出现错误。有三种方式可以修复该问题：</p><ul><li>不在线程之间共享该状态变量</li><li>将该状态变量修改为不可变的变量</li><li>再访问该状态变量时使用同步</li></ul></blockquote><p>第一种办法属于一刀切，很有效但适用度不高。第二种属于函数式编程思想，设计使用起来不比并发编程简单。第三种就是有不可分割特性的同步操作了。实现形式上的原子性，一般就是锁了。不过不聊锁，先聊聊异步回调。</p><h2 id=调度器迭代器>调度器、迭代器</h2><h2 id=io-模型之非阻塞>IO 模型之非阻塞</h2><h2 id=heading></h2><h2 id=实现>实现</h2><h2 id=参考>参考</h2><ul><li><a href=https://jolestar.com/parallel-programming-model-thread-goroutine-actor/>并发之痛 Thread，Goroutine，Actor</a></li></ul></article><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">上一页</span>
<a href=/posts/install-hyprland-on-arch-and-simple-beautify/ class=block>Arch + Hyprland 安装手册</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">下一页</span>
<a href=/posts/how-to-write-code-that-is-easy-to-maintain/ class=block>如何写一手容易维护的代码</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>本页内容</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#理论指导实践>理论指导实践</a><ul><li><a href=#任务执行单元定义>任务/执行单元定义</a></li><li><a href=#抢占式调度>抢占式调度</a></li><li><a href=#协作式调度>协作式调度</a></li><li><a href=#线程与协程>线程与协程</a></li></ul></li><li><a href=#实践中的问题>实践中的问题</a><ul><li><a href=#内存模型一致性>内存模型，一致性</a></li><li><a href=#算法操作原子性>算法操作，原子性</a></li><li><a href=#合适的同步>合适的“同步”</a></li></ul></li><li><a href=#调度器迭代器>调度器、迭代器</a></li><li><a href=#io-模型之非阻塞>IO 模型之非阻塞</a></li><li><a href=#heading></a></li><li><a href=#实现>实现</a></li><li><a href=#参考>参考</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>相关</h3><a href=/posts/how-to-write-code-that-is-easy-to-maintain/ class=no-underline>如何写一手容易维护的代码</a><br><a href=/posts/build-a-proxy-gateway-based-on-iptables-and-clash/ class=no-underline>iptables + clash 透明网关实践与总结</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">zonowry &#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>