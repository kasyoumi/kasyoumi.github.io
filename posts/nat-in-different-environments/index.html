<!doctype html><html lang=zh dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Drafft: NAT 穿透在不同环境下的表现 | Zonowry 的博客</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://blog.zonowry.com/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://blog.zonowry.com/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<link rel=stylesheet href=https://blog.zonowry.com/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://blog.zonowry.com/js/fontawesome.min.8c77c7521b1f95ec2031c2a79f5c6a698aa4a0dba5ba649dfbc7f73994cddf3f494be6aac7e5724f35cbf72cfde09703.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://blog.zonowry.com/images/avatar_hu592978886036387a2c13d6a63e534067_442061_32x32_fill_box_center_3.png><link rel=apple-touch-icon sizes=180x180 href=https://blog.zonowry.com/images/avatar_hu592978886036387a2c13d6a63e534067_442061_180x180_fill_box_center_3.png><meta name=description content="给我一根网线，我可以在北极打开家里那台笨重但大马力的台式机。接着坐在冰面上，望着电脑桌面上不重样的游戏图标。当一阵寒风吹过，回神时发现手里亮着的手机，正循环播放着一种黑色丝绸类的竖屏视频。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章列表","item":"https://blog.zonowry.com/posts/"},{"@type":"ListItem","position":2,"name":"Drafft: NAT 穿透在不同环境下的表现","item":"https://blog.zonowry.com/posts/nat-in-different-environments/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.zonowry.com/posts/nat-in-different-environments/"},"headline":"Drafft: NAT 穿透在不同环境下的表现 | Zonowry 的博客","datePublished":"2024-08-16T00:00:00+00:00","dateModified":"2024-08-16T00:00:00+00:00","wordCount":2433,"publisher":{"@type":"Person","name":"WANG Chucheng","logo":{"@type":"ImageObject","url":"https://blog.zonowry.com/images/avatar.png"}},"description":"给我一根网线，我可以在北极打开家里那台笨重但大马力的台式机。接着坐在冰面上，望着电脑桌面上不重样的游戏图标。当一阵寒风吹过，回神时发现手里亮着的手机，正循环播放着一种黑色丝绸类的竖屏视频。"}</script><meta property="og:title" content="Drafft: NAT 穿透在不同环境下的表现 | Zonowry 的博客"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.zonowry.com/images/avatar.png"><meta property="og:url" content="https://blog.zonowry.com/posts/nat-in-different-environments/"><meta property="og:description" content="给我一根网线，我可以在北极打开家里那台笨重但大马力的台式机。接着坐在冰面上，望着电脑桌面上不重样的游戏图标。当一阵寒风吹过，回神时发现手里亮着的手机，正循环播放着一种黑色丝绸类的竖屏视频。"><meta property="og:locale" content="zh"><meta property="og:site_name" content="Zonowry 的博客"><meta property="article:published_time" content="2024-08-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-16T00:00:00+00:00"><meta property="article:section" content="posts"><meta property="article:tag" content="article"><meta property="article:tag" content="nat"><meta property="article:tag" content="network"><meta property="og:see_also" content="https://blog.zonowry.com/posts/build-a-proxy-gateway-based-on-iptables-and-clash/"><meta property="og:see_also" content="https://blog.zonowry.com/posts/deploy-k3s-+-rancher-on-pve-container/"><meta property="og:see_also" content="https://blog.zonowry.com/posts/install-hyprland-on-arch-and-simple-beautify/"><meta property="og:see_also" content="https://blog.zonowry.com/posts/how-to-write-code-that-is-easy-to-maintain/"><meta property="og:see_also" content="https://blog.zonowry.com/posts/steps-to-flash-redmi-ax6s-router-with-openwrt/"><meta property="og:see_also" content="https://blog.zonowry.com/posts/how-to-do-safe-concurrent-programming/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Zonowry 的博客</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">首页</a>
<a href=/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">文章</a>
<a href=/thinks/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">碎碎念</a>
<a href=/firends/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">友链</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>浅色</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>深色</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>自动</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>Drafft: NAT 穿透在不同环境下的表现</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2024-08-16</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>5分钟阅读时长</span></div></div><h2 id=前言>前言</h2><p>有时候会觉得 BT 以及可以实现 P2P 的 VPN 很”魔法“，因为一直对端到端直连的技术细节好像知道，又好像不知道。借着捣鼓了一阵 wireguard 组网，写下本文加深下对 P2P 理解。</p><p>配置这些工具没什么难度，但背后的技术路径却很有意思。 tailscale 那片著名的 NAT 文章讲的很全面，本文也是主要结合这篇文章总结下 NAT 穿透的各种难度。</p><h2 id=完整又原始的-wireguard>完整又原始的 wireguard</h2><p>单纯用 wireguard 实现中转组网的话很简单，只需要一个中转服务器。且有很多的开源工具辅助，例如 wireguard-ui、easy-wireguard&mldr;利用这些工具可以管理各个 peer，生成 conf 文件。</p><p>wireguard 已经足够“完整“了。跨平台的客户端、声明式的配置、自动化的路由 AllowIPs 等等。如上段所说，wireguard 算的上最轻便的组网方案了，一般情况下很好用。</p><p>但想用 vanilla wireugard 实现 <code>peer-to-peer</code> 直连的话，就要手动配置每个 peer 的 endpoint。如果 peer 的数量是 n ，那么这将是一个 <code>O(n^2 - n)</code> 的工作，还不包括路由转发的配置工作，并且每个 peer 的公网地址也很难是固定的。</p><p>这些任务很繁重，没有在 github 上找到一个 vanilla wireguard 的自动化处理这些任务的工具，不过基于 wireguard 的上层工具倒是不少。</p><p>最终采用了 headscale，是 tailscale 服务器的开源版，基于 wireguard 实现。也算是一个 wireguard 自动化配置工具。简单配置下即可实现端到端直连需求，tailscale 客户端会自动添加 iptables 规则等路由操作。</p><p>回到正题，接下来从简单到困难，盘点下 NAT 穿透的各种难度。</p><h2 id=最简陋的环境>最简陋的环境</h2><p>首先抽象一个“很简陋”的 NAT 环境下的端到端直连，简陋是指对端防火墙允许一切传入。此时只要一端想办法得到对端的公网地址后，就可以直连。如何得到对端的公网地址也很简单，架设一个类似 DDNS 服务的“协调器”，两个端点访问协调器时，协调器自然可以看到端点的公网地址。</p><p>这个协调器服务称之为 <code>STUN (Session Traversal Utilities for NAT)</code>，STUN 记录了每个端点的公网 IP，可以告诉各个端点对端的地址，让其自己去建立连接。</p><p>只要各个端点向 STUN 上报自己的地址就可以，虽然很简单，但这样确实就足够了。</p><h2 id=最常见的环境>最常见的环境</h2><p>STUN 的原理看上去十分简单，其实就是很简单。不过当 NAT 环境变得不“简陋”，即对端不允许一切传入，只允许传出的响应数据包。这也是大多 NAT 防火墙的默认配置。此时 STUN 会受到一些限制。</p><p>想象一下这种情况下 STUN 协助端到端建连的过程：首先一端建立一个 socket 访问 STUN 获取对端的地址，接着再建立一个 socket 访问对端，这时当然会被对端的 NAT 防火墙拦截，因为对端拒绝一切传入。</p><p>穿透只能到此为止了吗？前面说到，有状态防火墙允许一种“特殊的传入”，即自身传出的响应，否则我们就没办法愉快问对方是 GG 还是 MM 了。</p><p>回到 STUN 的限制上，就是我们要让对端防火墙认为我们的是“响应”。记得吗，对端也向 STUN 传出了数据包，所以 STUN 知道对端 NAT 此时开放（映射）的地址（端口），这个端口可以接受响应传入。</p><p>另一端则可以向对端的这个端口发送数据包，随后基于这个端口开始通信~~，可以开始为所欲为了~~。显而易见我们用来直连（穿透）的 socket 重用了访问 STUN 的 socket。</p><p>这就是为什么与 STUN 通信和 NAT 穿透要使用同一个 socket。</p><h2 id=有点难度的环境>有点难度的环境</h2><p>STUN 的限制似乎也不是很麻烦，最终来看只是限制只使用一个端口而已。</p><p>不过都知道 NAT 按照所谓的“锥形“分为四个等级，这个“锥形”划分比较抽象，我们不用。更容易理解的分类是 easy nat 和 hard nat，根据“是否依赖目的地址”划分的。</p><p>easy nat 是不依赖目的地址的一种 nat，顾名思义是较为容易穿透 (?) 的 NAT。Esay NAT 的特点是：内网机器同一个 socket 发出去数据包，经过 nat 映射后，nat 为此 socket 创建的端口是固定的。不管这个 socket 是发往 1.1.1.1，还是发往 2.2.2.2 的，即目的地址不相关。这也是我们上一步“最常见的环境”中可以成功直连的原因。</p><p>Hard NAT 就是依赖目的地址那种了，特点是：内网机器就算用同一个 socket 发出的数据包，经过 NAT 后，如果发往目的地址不一致。NAT 会为该 socket 的每一个目的地址映射一个不同的端口，等待目的地址的响应。</p><p>回到 STUN 上，当 Hard NAT 的一端向 STUN 服务器上报地址时，STUN 拿到的是独属于自己（STUN）的地址，只有 STUN 的响应被允许传入，对端的“响应”会被 Hard NAT 拦截。</p><p>想象一个理想的流程，肯定得由 Hard NAT 的一端先向 Easy NAT 的对端发送请求，Esay NAT 的一端拿到了独属于自己的地址（端口），开始基于这个端口开始通信。好像很自然，但问题是此时 Easy NAT 会拦截掉这个数据包，Hard NAT 给我们开放的这个专属端口遗落进网络长河中。</p><p>简单的魔改下 NAT 设备，让其记录下这个对端地址，如果可以办得到的话。除此以外，我们如何找到这个被遗落的端口？</p><p>前文说到 Hard NAT 设备对于 socket 的目的地址是关心的。即同一个 socket 发往 1.1.1.1 与发往 2.2.2.2 的数据包在经过 Hard NAT 设备映射后，是两个端口。所以当两端向对端发送数据包时，各个端点 NAT 设备映射的端口只有自己那端的 NAT 设备自己知道。</p><p>众所周知端口的数量只有 65535 个，让 Easy NAT 背后的端点暴力猜测那个“专属”端口也不是不可以~~（傲娇早就退环境了啊！）~~。不过从 1 开始遍历有点傻，让 Hard NAT 背后的端点多开点 socket 向 Easy NAT 发几次包，再利用点算法（生日悖论）提高猜中的概率。</p><p>当Easy NAT 猜中后，就可以基于这个猜中的端口通信了~~（可以继续愉快的为所欲为了）~~。</p><h2 id=搞不定的环境>搞不定的环境</h2><p>当一端是 Easy NAT，另一端是 Hard NAT 的话，限制又多了一个穿透必须由 Hard NAT 端发起。但只要从 STUN 服务器拿到对端IP，再花费几秒钟猜测一次端口，这也是可以接受的。</p><p>可当两端都是 Hard NAT 呢？所以 STUN 服务器是无法在两端都是 Hard Nat 情况下的协助打洞的，只能走中转方案。</p><p>本文可以当作 tailscale + headscale 搭建手册食用，不过更多的是梳理一些碎片知识，以便理解我们到底在配置些什么。</p><p>最终我的打洞&组网方式是”tailscale + headscale“。</p><blockquote><p>百分百成功率让两个 peer 打洞直连，至少有一个 peer 持有公网 IP，且可以配置这个 peer 的 NAT 设备的端口转发，目的是转发 tailscale 监听的 41641 端口。这里要问了，可以配置端口转发了，还打什么洞。这种情况下利用 tailscale 打洞的优点是只需要转发一个 41641 端口，安全性只交给 tailscale（wireguard）。</p><p>有公网 ip 的话，即使不配置端口转发，成功率也是很高的，只要线路上没有 <code>hard nat</code> 设备。</p></blockquote><h2 id=百分百可以成功的环境>百分百可以成功的环境</h2></article><div class=my-4><a href=https://blog.zonowry.com/tags/article/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#article</a>
<a href=https://blog.zonowry.com/tags/nat/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#nat</a>
<a href=https://blog.zonowry.com/tags/network/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#network</a></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">下一页</span>
<a href=https://blog.zonowry.com/posts/how-to-retrieve-data-in-relational-database/ class=block>关系型数据库如何检索数据</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>本页内容</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#完整又原始的-wireguard>完整又原始的 wireguard</a></li><li><a href=#最简陋的环境>最简陋的环境</a></li><li><a href=#最常见的环境>最常见的环境</a></li><li><a href=#有点难度的环境>有点难度的环境</a></li><li><a href=#搞不定的环境>搞不定的环境</a></li><li><a href=#百分百可以成功的环境>百分百可以成功的环境</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>相关</h3><a href=https://blog.zonowry.com/posts/build-a-proxy-gateway-based-on-iptables-and-clash/ class=no-underline>iptables + clash 透明网关实践与总结</a><br><a href=https://blog.zonowry.com/posts/deploy-k3s-+-rancher-on-pve-container/ class=no-underline>在 PVE 容器上部署 k3s + rancher</a><br><a href=https://blog.zonowry.com/posts/install-hyprland-on-arch-and-simple-beautify/ class=no-underline>Arch + Hyprland 安装手册</a><br><a href=https://blog.zonowry.com/posts/how-to-write-code-that-is-easy-to-maintain/ class=no-underline>如何写一手容易维护的代码</a><br><a href=https://blog.zonowry.com/posts/steps-to-flash-redmi-ax6s-router-with-openwrt/ class=no-underline>红米 AX6S 路由器刷入纯净最新 ImmortalWrt 步骤</a><br><a href=https://blog.zonowry.com/posts/how-to-do-safe-concurrent-programming/ class=no-underline>怎样安全的并发编程</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">zonowry &#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>