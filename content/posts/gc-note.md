---
title: 垃圾回收知识梳理
date: 2022-12-24
tags: [java,垃圾回收,知识]
categories: 文章
description: "垃圾一般就是指没用了的对象。对象的值一般存储在堆空间中。而基础类型、对象的引用以及大小确定的一些结构类型存储在栈空间中，函数执行就是靠不停的进出方法栈，每执行一步，就会退出一个栈，清理掉这些栈空间数据，切换到下一个栈。

也即对象的引用被销毁掉了，那么堆空间对象的值就变成无用数据了。所以通常我们讲垃圾回收都是在针对堆空间中的对象值。

在c/c++中，对象提供了析构函数让我们手动释放资源。而在java等托管语言中，有虚拟机提供了垃圾回收机制，帮我们处理这些在堆内存中没用了的对象（垃圾）"
---

## 堆内存与栈内存

垃圾一般就是指没用了的对象。对象的值一般存储在堆空间中。而基础类型、对象的引用以及大小确定的一些结构类型存储在栈空间中，函数执行就是靠不停的进出方法栈，每执行一步，就会退出一个栈，清理掉这些栈空间数据，切换到下一个栈。

也即对象的引用被销毁掉了，那么堆空间对象的值就变成无用数据了。所以通常我们讲垃圾回收都是在针对堆空间中的对象值。

在c/c++中，对象提供了析构函数让我们手动释放资源。而在java等托管语言中，有虚拟机提供了垃圾回收机制，帮我们处理这些在堆内存中没用了的对象（垃圾）。


## 如何识别标记垃圾

那接下来的重点就是虚拟机如何讲对象识别为垃圾，这样虚拟机才能回收垃圾。一般有两种方法，引用计数和根搜索算法。

### 引用计数算法

顾名思义，一个对象被创建后，我们计数这个对象被引用的次数。如果引用次数为0，则说明这个对象不再被使用了。

同时也引出了一个巨大的问题，当出现两个对象互相引用时，引用计数永远不会到达0。那么就造成了内存泄漏。所以引用计数算法现在已经退隐江湖了，只在很早期的虚拟机中出现过。


### 根搜索算法

根搜索算法也很容易理解。我们从一个“根对象”开始出发，想象出一个图状结构，形成一条条连接的引用链。不在这些引用链中的对象，就是垃圾对象。

核心思想就是找到不可达的对象，这些不可达的对象自然就是垃圾对象了。

![根搜索算法](/images/blog/root-search.png)

## 如何回收垃圾

### 回收步骤

> 垃圾回收有很多算法，本文仅简单概述常见的，算法具体逻辑及实现可以百度看看其它文章。

首先是回收标记的垃圾对象。当我们回收完毕后，内存空间可能会出现不连续，造成空间浪费。垃圾回收器就需要对内存碎片进行整理。所以垃圾回收就是再做：标记-回收-整理，三个步骤。

### 回收算法

总结出规律，聪明的程序员就发明了高性能的整理回收算法。称之为 `复制算法 Scavenge` 。具体逻辑就是将内存空间对半分，回收时，将存活的对象复制到另一半空间中。最终一半空间是非活动对象，一半空间全是存活对象。垃圾回收器可以轻松的将一半空间清除，使之变为空闲区域。


### 垃圾分代

只用一种算法提升还不够大，程序员们就又针对空间使用规律。提出了对象分代的理念。区分长命的对象和短命的对象。常见的一种区分方式是：经过几轮垃圾回收还存活的，就是长命对象。反之则为短命对象。分别称之为新生代，老年代。

然后针对不同类别的对象实行不同的回收算法，有了针对性，也就节省了很多性能和空间开销。


## 扩展知识

除了这些通用的垃圾回收机制外。不同的编程语言虚拟机还提供了不同的特性。例如 java 虚拟机就提供了”强引用、软引用、弱引用和虚引用"特性。增强我们对对象的生命周期控制，影响垃圾回收器的工作。

可以看其它大佬的文章了解这些知识：[理解Java的强引用、软引用、弱引用和虚引用](https://juejin.cn/post/6844903665241686029)

所以具体垃圾回收器，还是需要具体学习。不过知道这些知识也够用了～




